<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>A Brief History of Rocket Launches</title>
  <link href='http://fonts.googleapis.com/css?family=Titillium+Web:600' rel='stylesheet' type='text/css'>
  <link href="css/d3.slider.css" rel="stylesheet" type="text/css">
  <style>
    body {
      background-color: #242424;
      color: #fff;
      font-family: 'Titillium Web', sans-serif;
    }
    circle {
      fill: #04CCFF;
    }
    .country {
      stroke: #000;
      stroke-width: 0.1px;
    }
    .text {
      font-size:10px;
      text-transform:capitalize;
    }
    #container {
      margin:10px 10%;
      height:100%;
    }
    #map {
      border: 2px solid #606060;
    }
    .hidden { 
      display: none; 
    }
    div.tooltip {
      color: #222; 
      background: #fff; 
      padding: .5em; 
      text-shadow: #f5f5f5 0 1px 0;
      border-radius: 2px; 
      box-shadow: 0px 0px 2px 0px #a6a6a6; 
      opacity: 0.9; 
      position: absolute;
    }

    .launch_success {
      fill: #00FF00;
    }

    .launch_failure {
      fill: #FF0000;
    }
  </style>
</head>
<body>

  <h1>ROCKET LAUNCHES</h1>
  <p>Map code adapted from <a href="http://techslides.com/d3-map-starter-kit/">techslides</a>.</p>

  <div id="container"></div>
  <div id="slider"></div>
  <br>
  <div id="slidermin"></div><div id="slidermax"></div>

  <script src="js/d3.min.js"></script>
  <script src="js/topojson.v1.min.js"></script>
  <script src="js/d3.slider.js"></script>
  <script>
    // We should wrap this with an onload, and move all the
    // scripting up into the head
    d3.select(window).on("resize", throttle);

    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 9])
        .on("zoom", move);

    var month_map = {
      'Jan': 1,
      'Feb': 2,
      'Mar': 3,
      'Apr': 4,
      'May': 5,
      'Jun': 6,
      'Jul': 7,
      'Aug': 8,
      'Sep': 9,
      'Oct': 10,
      'Nov': 11,
      'Dec': 12
    };

    var launch_data = {};// [year][month][day]=> [array of entries]
    loadLaunchData();

    var launch_sites = [];// Stores launch sites
    loadLaunchSites();

    var current_launches = []; // Stores current launches to display

    var width = document.getElementById('container').offsetWidth;
    var height = width / 2;

    var topo,projection,path,svg,g;

    var tooltip = d3.select("#container").append("div").attr("class", "tooltip hidden");

    setup(width,height);

    function setup(width,height){
      projection = d3.geo.mercator()
        .translate([(width/2), (height/1.4)])
        .scale( width / 2 / Math.PI);

      path = d3.geo.path().projection(projection);

      svg = d3.select("#container").append("svg")
          .attr("width", width)
          .attr("height", height)
          .attr("id", "map")
          .call(zoom)
          .on("click", click)
          .append("g");

      // TODO: figure out filters
      var defs = svg.append("defs");

      var filter = defs.append("filter")
                       .attr("id", "glow");

      filter.append("feGaussianBlur")
            .attr("in", "SourceGraphic")
            .attr("stdDeviation", 10);

      // Set background color
      svg.append("rect")
         .attr("width", "100%")
         .attr("height", "100%")
         .attr("fill", "#1A181D");

      g = svg.append("g");
    }

    d3.json("data/world-topo-min.json", function(error, world) {
      var countries = topojson.feature(world, world.objects.countries).features;
      topo = countries;
      draw(topo);
    });

    function draw(topo) {
      var country = g.selectAll(".country").data(topo);

      // Add countries
      country.enter().insert("path")
          .attr("class", "country")
          .attr("d", path)
          .attr("id", function(d,i) { return d.id; })
          .attr("title", function(d,i) { return d.properties.name; })
          .style("fill", "#606060");

      // Add launch sites
      var site;
      for(var i=0;i<launch_sites.length;i++) {
        site = launch_sites[i];
        addpoint(site.Longitude, site.Latitude, site.FullName, 'launch_site');
      }

      // Could remove old launches here

      var info;
      for(var i=0;i<current_launches.length;i++) {
        info = current_launches[i].info;
        cls = (info.Success == 'S') ? 'launch_success' : 'launch_failure';
        addpoint(info.Longitude, info.Latitude, info["Launch Vehicle"], cls);
      }
    }

    function redraw() {
      width = document.getElementById('container').offsetWidth;
      height = width / 2;
      d3.select('svg').remove();
      setup(width,height);
      draw(topo);
    }


    function move() {
      var t = d3.event.translate;
      var s = d3.event.scale; 
      zscale = s;
      var h = height/4;

      t[0] = Math.min(
        (width/height)  * (s - 1), 
        Math.max( width * (1 - s), t[0] )
      );

      t[1] = Math.min(
        h * (s - 1) + h * s, 
        Math.max(height  * (1 - s) - h * s, t[1])
      );

      zoom.translate(t);
      g.attr("transform", "translate(" + t + ")scale(" + s + ")");
    }

    var throttleTimer;
    function throttle() {
      window.clearTimeout(throttleTimer);
        throttleTimer = window.setTimeout(function() {
          redraw();
        }, 200);
    }

    //geo translation on mouse click in map
    function click() {
      var latlon = projection.invert(d3.mouse(this));
      console.log(latlon);
    }

    // add points and text to the map
    function addpoint(lat,lon,text,cls) {
      //offsets for tooltips
      var offsetL = document.getElementById('container').offsetLeft+20;
      var offsetT = document.getElementById('container').offsetTop+10;

      var gpoint = g.append("g").attr("class", "gpoint");
      var x = projection([lat,lon])[0];
      var y = projection([lat,lon])[1];

      gpoint.append("svg:circle")
            .attr("cx", x)
            .attr("cy", y)
            .attr("class","point " + cls)
            .attr("r", 3);

      gpoint
        .on("mousemove", function(d,i) {
          var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

          tooltip.classed("hidden", false)
                 .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
                 .html(text);

          })
          .on("mouseout",  function(d,i) {
            tooltip.classed("hidden", true);
          }); 
    }

    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    var initialvalues = [1957.7, 2015.2];
    d3.select('#slider')
      .style("width", width + "px")
      .style("margin", "0px auto")
      .call(d3.slider()
        .axis(true)
        .min(initialvalues[0])
        .max(initialvalues[1])
        .value(initialvalues)
        .on("slide", updateSliderValues));

    updateSliderValues(null, initialvalues);

    // value = [ mindate, maxdate ] in decimal form
    function updateSliderValues(evt, value) {
      var mindate = convertDecimalDate(value[0]);
      var maxdate = convertDecimalDate(value[1]);
      d3.select("#slidermin").text(months[mindate.getMonth()] + " " + mindate.getFullYear());
      d3.select("#slidermax").text(months[maxdate.getMonth()] + " " + maxdate.getFullYear());
    }

    function leapYear(year) {
      return ((year % 4 == 0) && (year % 100 != 0)) || (year % 400 == 0);
    };

    function convertDecimalDate(decimalDate) {
      var year = parseInt(decimalDate);
      var remainder = decimalDate - year;
      var daysPerYear = leapYear(year) ? 366 : 365;
      var miliseconds = remainder * daysPerYear * 24 * 60 * 60 * 1000;
      var yearDate = new Date(year, 0, 1);
      return new Date(yearDate.getTime() + miliseconds);
    }

    // This loads the launch data from 'massive_launchlog' into
    // a data structure mapped by 'year'=>'month'=>'day'=>array of entries
    // Stored in `launch_data`
    function loadLaunchData() {
      d3.csv("data/massive_launchlog.csv", function(err, entries) {
        entries.forEach(function(entry) {
          var date_parts = entry["Launch Date and Time (UTC)"].split(" ");
          var year = date_parts[0] * 1;
          var month = month_map[date_parts[1]];
          var day = date_parts[2];

          // Ensure data structure is set up
          if(launch_data[year] == null) {
            launch_data[year] = {};
          }

          if(launch_data[year][month] == null) {
            launch_data[year][month] = {};
          }

          if(launch_data[year][month][day] == null) {
            launch_data[year][month][day] = [];
          }

          launch_data[year][month][day].push(entry);
        });
      });

    }

    // Loads launch site data from csv, storing entries in `launch_sites`
    function loadLaunchSites() {
      d3.csv("data/launch_sites.csv", function(err, sites) {
        sites.forEach(function(i){
          launch_sites.push(i);
        });
      });
    }

    // Adds points for the launches of a given day to the display
    // list, after clearing the previous display
    function displayDate(year, month, day) {
      var entries = [];

      if(launch_data[year] && launch_data[year][month] && launch_data[year][month][day]) {
        entries = launch_data[year][month][day];
      }

      // Right now this clears the points completely
      // Later we may change it to not clear, and just allow
      // the animation to continue
      current_launches = [];

      for(var i=0;i<entries.length;i++) {
        current_launches.push(
          {
            birthtime: (new Date()).getTime(),
            info: entries[i]
          }
        );
      }

      redraw();
    }
  </script>
</body>
</html>
